<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="icon" href="img/favicon.ico">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap4-toggle.min.css">
    <link rel="stylesheet" href="css/index.css">

    <script type="text/javascript" src="js/bootstrap4-toggle.min.js"></script>
    <script type="text/javascript" src="/eel.js"></script>
    <script type="text/javascript">
      async function check_found_imgs(img_dir) {
        let n_imgs_found = await eel.check_found_imgs(img_dir)();
        document.getElementById('num_imgs_found').innerHTML = ('Found ' + n_imgs_found + ' images');
      }

      async function check_dir_exists(dir) {
        let exists = await eel.check_dir_exists(dir)();
        if (exists) {
          document.getElementById('out_dir_exists').innerHTML = ('Directory already exists and will be overwritten!');
        } else {
          document.getElementById('out_dir_exists').innerHTML = ('');
        }
      }

      async function guess_img_dir() {
        let img_dir = await eel.guess_img_dir()();
        document.getElementById('img_dir_form').value = img_dir;
        check_found_imgs(img_dir);
      }

      async function guess_out_dir() {
        let out_dir = await eel.guess_out_dir()();
        document.getElementById('out_dir_form').value = out_dir;
        check_dir_exists(out_dir);
      }

      eel.expose(update_img_results);
      function update_img_results(img0, img1, img2, img3, iranges, prog) {
        $("#proc_img0").attr("src", "data:image/png;base64," + img0);
        $("#proc_img1").attr("src", "data:image/png;base64," + img1);
        $("#proc_img2").attr("src", "data:image/png;base64," + img2);
        $("#proc_img3").attr("src", "data:image/png;base64," + img3);
        $('#img0_label').text('Original (' + iranges[0] + ' - ' + iranges[1] + ')');
        $('#img2_label').text('Result (' + iranges[2] + ' - ' + iranges[3] + ')');
        if (prog < 100) {
          $('#proc_img_progress').css('width', Math.floor(prog) + "%");
          $('#proc_img_progress').text(Math.floor(prog) + "%")
        } else {
          $('#proc_img_progress').css('width', "100" + "%");
          $('#proc_img_progress').text('DONE!');
          $('#proc_img_progress').addClass('bg-success');
          $('#protocol_button').toggleClass('btn-danger proto-stop', false);
          $('#protocol_button').toggleClass('proto-start btn-success', true);
          $('#protocol_button').text("Start Protocol");
        }
      }
      eel.expose(is_proc_imgs_stopped);
      function is_proc_imgs_stopped() {
        return $('#protocol_button').hasClass('proto-start');
      }
    </script>

    <title>Cytomata</title>
  </head>
  <body class="py-3">
    <div class="modal fade" id="view_coords_modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Coordinates (x, y, z)</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                (2300.34, 120.75, 4230.34)
                <div>
                  <button type="button" class="btn btn-success btn-sm"><</button>
                  <button type="button" class="btn btn-danger btn-sm">&times;</button>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="acquire_z_modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Acquire Z-Stack</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-row">
              <div class="input-group col-4">
                <div class="input-group-prepend">
                  <span class="input-group-text">z-min</span>
                </div>
                <input type="text" class="form-control" id="z-min" placeholder="4100">
              </div>
              <div class="input-group col-4">
                <div class="input-group-prepend">
                  <span class="input-group-text">z-max</span>
                </div>
                <input type="text" class="form-control" id="z-max" placeholder="4300">
              </div>
              <div class="input-group col-4">
                <div class="input-group-prepend">
                  <span class="input-group-text">z-step</span>
                </div>
                <input type="text" class="form-control" id="z-step" placeholder="50">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Run</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="acquire_xy_modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Acquire XY-Field</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-row">
              <div class="input-group col-6">
                <div class="input-group-prepend">
                  <span class="input-group-text">field-width</span>
                </div>
                <input type="text" class="form-control" id="field-width" placeholder="5">
              </div>
              <div class="input-group col-6">
                <div class="input-group-prepend">
                  <span class="input-group-text">field-step</span>
                </div>
                <input type="text" class="form-control" id="field-step" placeholder="81.92">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Run</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="config_expt_modal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Configure Experiment</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="container-fluid">
              <h5>Induction</h5>
              <div class="input-group">
                <div class="input-group-prepend"><span class="input-group-text">Times</span></div>
                <input type="text" class="form-control" id="ind_times" placeholder="(0, 86400, 60, 5)">
              </div>
              <small class="form-text text-muted mb-3">(start, stop, period, width), (...),...</small>
              <div class="form-row">
                <div class="input-group col-6 mb-3">
                  <div class="input-group-prepend">
                    <span class="input-group-text">Dark Ch</span>
                  </div>
                  <select class="custom-select" id="ch_dark">
                    <option value='0'>DIC</option>
                    <option value='1'>GFP</option>
                    <option value='2'>mCh</option>
                  </select>
                </div>
                <div class="input-group col-6 mb-3">
                  <div class="input-group-prepend">
                    <span class="input-group-text">Ind Ch</span>
                  </div>
                  <select class="custom-select" id="ch_ind">
                    <option value='0'>DIC</option>
                    <option value='1'>GFP</option>
                    <option value='2'>mCh</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid d-flex flex-column h-100 col-9">
      <div class="row px-0 mb-2">
        <ul class="nav nav-pills mb-2" id="pills-tab" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="pills-home-tab" data-toggle="pill" href="#pills-home" role="tab">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="pills-mic-tab" data-toggle="pill" href="#pills-mic" role="tab">Microscope</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="pills-proc-tab" data-toggle="pill" href="#pills-proc" role="tab">Processing</a>
          </li>
        </ul>
      </div>
      <div class="row card p-3 flex-grow-1 border-primary">
        <div class="tab-content flex-grow-1" id="pills-tabContent">
          <div class="tab-pane fade show active pyp-5" id="pills-home" role="tabpanel">
            <div class="row justify-content-center">
              <img class="" src="img/logo_full.png">
            </div>
            <div class="row justify-content-center mt-3">
              <div class="col-6 custom-file">
                <input type="file" class="custom-file-input" id="customFile">
                <label class="custom-file-label" for="customFile">Select MicroManager Config File</label>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="pills-mic" role="tabpanel">
            <div class="row pr-3">
              <div class="col-5 pb-3 pr-3">
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <button class="btn btn-outline-success" type="button"><</button>
                  </div>
                  <input type="text" class="form-control" placeholder="X : 4502.23">
                  <div class="input-group-append">
                    <button class="btn btn-outline-success" type="button">></button>
                  </div>
                </div>
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <button class="btn btn-outline-success" type="button"><</button>
                  </div>
                  <input type="text" class="form-control" placeholder="Y : 4502.23">
                  <div class="input-group-append">
                    <button class="btn btn-outline-success" type="button">></button>
                  </div>
                </div>
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <button class="btn btn-outline-success" type="button"><</button>
                  </div>
                  <input type="text" class="form-control" placeholder="Z : 4502.23">
                  <div class="input-group-append">
                    <button class="btn btn-outline-success" type="button">></button>
                  </div>
                </div>
                <div class="form-row">
                  <div class="input-group col-6 mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text">Exp&nbsp;</span>
                    </div>
                    <input type="text" class="form-control" id="cam_exposure" placeholder="100">
                  </div>
                  <div class="input-group col-6 mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text">Gain</span>
                    </div>
                    <select class="custom-select" id="gain">
                      <option value='0'>1</option>
                      <option value='1'>2</option>
                      <option value='2'>3</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="input-group col-6 mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text">Mag</span>
                    </div>
                    <select class="custom-select" id="mag">
                      <option value='0'>10x</option>
                      <option value='1'>20x</option>
                      <option value='2'>40x</option>
                    </select>
                  </div>
                  <div class="input-group col-6 mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text">Chan</span>
                    </div>
                    <select class="custom-select" id="chan">
                      <option value='0'>DIC</option>
                      <option value='1'>GFP</option>
                      <option value='2'>mCh</option>
                    </select>
                  </div>
                </div>
                <div class="form-row px-1 mb-3">
                  <button class="col-5 mr-3 btn btn-outline-primary" type="button">Add Coord</button>
                  <button class="col-5 btn btn-outline-primary" type="button" data-toggle="modal" data-target="#view_coords_modal">View Coords</button>
                </div>
                <div class="form-row px-1 mb-3">
                  <button class="col-5 mr-3 btn btn-outline-primary" type="button" data-toggle="modal" data-target="#acquire_z_modal">Acquire Z-Stack</button>
                  <button class="col-5 btn btn-outline-primary" type="button" data-toggle="modal" data-target="#acquire_xy_modal">Acquire XY-Field</button>
                </div>
                <div class="form-row px-1">
                  <button class="col-11 btn btn-outline-primary" type="button" data-toggle="modal" data-target="#config_expt_modal">Configure Experiment</button>
                </div>
              </div>
              <div class="col-7 pb-3 pl-3">
                <div class="row justify-content-between">
                  <div class="col-10 input-group">
                    <input type="text" class="form-control" id="snap_save_dir" placeholder="Save Directory">
                    <div class="input-group-append">
                      <button class="btn btn-outline-primary px-4" type="button">Snap</button>
                    </div>
                  </div>
                  <button class="col-2 btn btn-outline-primary" type="button">Live</button>
                </div>
                <img id="live_window" src="" class="invisible img-fluid">
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="pills-proc" role="tabpanel">
            <div class="row px-3">
              <div class="col-4 pb-3 pr-3 pl-3">
                <h3>Settings</h3>
                <form>
                  <div class="form-group">
                    <label for="img_dir_form">Images Directory</label>
                    <input type="text" class="form-control" id="img_dir_form" placeholder="Images Directory">
                    <small id="num_imgs_found" class="form-text text-muted"></small>
                  </div>
                  <div class="form-group">
                    <label for="out_dir_form">Output Directory</label>
                    <input type="text" class="form-control" id="out_dir_form" placeholder="Output Directory">
                    <small id="out_dir_exists" class="form-text text-danger"></small>
                  </div>
                  <div class="form-group">
                    <label for="protocol_form">Protocol</label>
                    <select class="form-control" id="protocol_form">
                      <option value='0'>Ave Frame Intensities</option>
                      <option value='1'>Single Cell Intensities</option>
                    </select>
                  </div>
                  <div class="py-2">
                    <div class="custom-control custom-checkbox custom-control-inline">
                      <input type="checkbox" class="custom-control-input" id="denoise_checkbox">
                      <label class="custom-control-label" for="denoise_checkbox">Perform Denoising</label>
                    </div>
                    <small id="warn_den_sty" class="form-text text-muted"></small>
                  </div>
                  <div class="form-group">
                    <label id= "thres_block_label" class="mt-2" for="thres_block_slider">Background Smoothing (501)</label>
                    <input id="thres_block_slider" type="range" class="custom-range mb-2" min="1" max="1001" step="50" value="501">
                  </div>
                  <div class="form-group">
                    <label id= "sub_offset_label" class="mb-0" for="sub_offset_slider">Background Offset (0.0)</label>
                    <input id="sub_offset_slider" type="range" class="custom-range mb-2" min="-3.0" max="3.0" step="0.1" value="0.0">
                  </div>
                  <div id="sc_track_settings" style="display: none;">
                    <div class="form-group">
                      <label id= "det_sens_label" class="mb-0" for="det_sens_slider">Region Detection Sensitivity (25)</label>
                      <input id="det_sens_slider" type="range" class="custom-range mb-2" min="10" max="60" step="1" value="25">
                    </div>
                    <div class="form-group">
                      <label id= "traj_len_label" class="mb-0" for="traj_len_slider">Minimum Trajectory Length (100)</label>
                      <input id="traj_len_slider" type="range" class="custom-range mb-2" min="0" max="500" step="10" value="100">
                    </div>
                  </div>
                  <button id="protocol_button" type="button" class="btn btn-success proto-start">Start Protocol</button>
                </form>
              </div>
              <div class="col-8 pb-3 pl-3">
                <div class="invisible pt-1" id="results_div">
                  <h3>Results</h3>
                  <div class="progress mb-1">
                    <div id="proc_img_progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                  </div>
                  <div class="row p-0 m-0">
                    <div class="col-4 p-1"><label id='img0_label'>Original</label><img id="proc_img0" src="" class="img-fluid"></div>
                    <div class="col-8 p-1"><img id="proc_img1" src="" class="img-fluid"></div>
                    <div class="col-4 p-1"><label id='img2_label'>Result</label><img id="proc_img2" src="" class="img-fluid"></div>
                    <div class="col-8 p-1"><img id="proc_img3" src="" class="img-fluid"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/jquery-3.3.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script type="text/javascript">
    guess_img_dir();
    guess_out_dir();

    $('#img_dir_form').on('change', function() {
      let img_dir = $('#img_dir_form').val();
      check_found_imgs(img_dir);
    });

    $('#out_dir_form').on('change', function() {
      let out_dir = $('#out_dir_form').val();
      check_dir_exists(out_dir);
    });

    $('#protocol_form').on('change', function() {
      let proto = $('#protocol_form').val();
      if (proto == 1) {
        $('#sc_track_settings').show();
      } else {
        $('#sc_track_settings').hide();
      }
    });

    $('#thres_block_slider').on('change', function() {
      let slider_val = $('#thres_block_slider').val();
      $('#thres_block_label').text('Background Smoothing (' + slider_val + ')');
    });

    $('#sub_offset_slider').on('change', function() {
      let slider_val = $('#sub_offset_slider').val();
      $('#sub_offset_label').text('Background Offset (' + slider_val + ')');
    });

    $('#det_sens_slider').on('change', function() {
      let slider_val = $('#det_sens_slider').val();
      $('#det_sens_label').text('Region Detection Sensitivity (' + slider_val + ')');
    });

    $('#traj_len_slider').on('change', function() {
      let slider_val = $('#traj_len_slider').val();
      $('#traj_len_label').text('Minimum Trajectory Length (' + slider_val + ')');
    });

    $('#protocol_button').on('click', function() {
      if ($(this).hasClass('proto-start')) {
        $('#results_div').toggleClass('visible', true);
        $('#results_div').toggleClass('invisible', false);
        $('#proc_img_progress').css('width', '0%');
        $('#proc_img_progress').text('');
        $('#proc_img_progress').removeClass('bg-success');
        $(this).toggleClass('btn-success btn-danger');
        $(this).toggleClass('proto-start proto-stop');
        $(this).text("Stop Protocol");
        let img_dir = $('#img_dir_form').val();
        let out_dir = $('#out_dir_form').val();
        let proto = $('#protocol_form').val();
        let param_thres_block = $('#thres_block_slider').val();
        let param_sub_offset = $('#sub_offset_slider').val();
        let param_det_sens = $('#det_sens_slider').val();
        let param_traj_len = $('#traj_len_slider').val();
        let param_denoise = $('#denoise_checkbox').prop('checked');
        let params = {
          thres_block: param_thres_block,
          sub_offset: param_sub_offset,
          det_sens: param_det_sens,
          traj_len: param_traj_len,
          denoise: param_denoise
        };
        eel.process_imgs(img_dir, out_dir, proto, params);
      } else {
        $('#results_div').toggleClass('visible', false);
        $('#results_div').toggleClass('invisible', true);
        $(this).toggleClass('btn-danger btn-success');
        $(this).toggleClass('proto-stop proto-start');
        $(this).text("Start Protocol");
      }
    });
    </script>
  </body>
</html>
